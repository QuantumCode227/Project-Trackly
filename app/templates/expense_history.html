{% extends "base.html" %}
{% set page_id = "expense_history" %}
{% block title %}Expense History â€” Trackly{% endblock %}
{% block content %}
<div class="history-container">
  <h1 class="history-title">Expense History</h1>

  <div class="history-table-container">
    {% if expenses %}
    <table class="history-table">
      <thead>
        <tr>
          <th>S.No.</th>
          <th>Item Name</th>
          <th>Amount (PKR)</th>
          <th>Date & Time of Purchase</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for expense in expenses %}
        <tr>
          <td data-label="S.No.">{{ loop.index }}</td>
          <td data-label="Item Name">{{ expense.item }}</td>
          <td data-label="Amount">Rs.{{ expense.amount | round(2) }}</td>
          <td data-label="Time of Purchase">{{ expense.date.strftime("%d-%b-%Y %I:%M %p") }}</td>
          <td data-label="Actions">
            <a href="{{ url_for('dashboard.update_expense', expense_id=expense.id) }}" class="edit-btn">Edit</a>

            <!-- Delete form -->
            <form method="POST" action="{{ url_for('dashboard.delete_expense', expense_id=expense.id) }}"
              class="delete-form" style="display:inline;">
              <button type="button" class="delete-btn">Delete</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <p class="no-data-message">No expense history found. Start by
      <a href="{{ url_for('dashboard.add_expense') }}">adding one!</a>
    </p>
    {% endif %}
  </div>
</div>

<!-- Modal -->
<div id="confirmModal" class="modal">
  <div class="modal-content">
    <h2>Are you absolutely sure?</h2>
    <p>This will permanently remove this expense. This cannot be undone.</p>
    <div class="modal-actions">
      <button id="confirmDelete" class="danger">Yes, delete</button>
      <button id="cancelDelete">Cancel</button>
    </div>
  </div>
</div>
{% endblock %}

{% block script %}
{{ super() }}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const modal = document.getElementById("confirmModal");
    const confirmBtn = document.getElementById("confirmDelete");
    const cancelBtn = document.getElementById("cancelDelete");
    let targetForm = null;

    const deleteButtons = document.querySelectorAll(".delete-btn");

    deleteButtons.forEach(btn => {
      btn.addEventListener("click", function (e) {
        e.preventDefault();
        targetForm = this.closest("form"); // jis form ka button click hua
        modal.style.display = "flex";
      });
    });

    cancelBtn.addEventListener("click", function () {
      modal.style.display = "none";
      targetForm = null;
    });

    confirmBtn.addEventListener("click", function () {
      if (targetForm) {
        targetForm.submit(); // ab POST request jayegi
      }
    });

    window.addEventListener("click", function (e) {
      if (e.target === modal) {
        modal.style.display = "none";
        targetForm = null;
      }
    });
  });
</script>
{% endblock %}