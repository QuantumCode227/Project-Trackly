{% extends "base.html" %}
{% set page_id = "income_history" %}
{% block title %}Income History â€” Trackly{% endblock %}
{% block content %}
<div class="history-container">
  <h1 class="history-title">Income History</h1>

  <div class="history-table-container">
    {% if incomes %}
    <table class="history-table">
      <thead>
        <tr>
          <th>S.No.</th>
          <th>Amount (PKR)</th>
          <th>Date</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for income in incomes %}
        <tr>
          <td data-label="S.No.">{{ loop.index }}</td>
          <td data-label="Amount">Rs.{{ income.amount | round(2) }}</td>
          <td data-label="Time of Purchase">{{ income.date.strftime("%d-%b-%Y %I:%M %p") }}</td>
          <td data-label="Actions">
            <a href="{{ url_for('dashboard.update_income', income_id=income.id) }}" class="edit-btn">Edit</a>

            <!-- Delete form -->
            <form method="POST" action="{{ url_for('dashboard.delete_income', income_id=income.id) }}"
              class="delete-form" style="display:inline;">
              <button type="submit" class="delete-btn">Delete</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <p class="no-data-message">No income history found. Start by <a href="{{ url_for('dashboard.add_income') }}">adding
        one!</a></p>
    {% endif %}
  </div>
</div>

<!-- Modal -->
<div id="confirmModal" class="modal">
  <div class="modal-content">
    <h2>Are you absolutely sure?</h2>
    <p>This will permanently remove this income. This cannot be undone.</p>
    <div class="modal-actions">
      <button id="confirmDelete" class="danger">Yes, delete</button>
      <button id="cancelDelete">Cancel</button>
    </div>
  </div>
</div>

{% endblock %}
{% block script %}
{{ super() }}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const modal = document.getElementById("confirmModal");
    const confirmBtn = document.getElementById("confirmDelete");
    const cancelBtn = document.getElementById("cancelDelete");
    let targetForm = null;

    const deleteForms = document.querySelectorAll(".delete-form");

    deleteForms.forEach(form => {
      form.addEventListener("submit", function (e) {
        e.preventDefault();
        targetForm = this;
        modal.style.display = "flex";
      });
    });

    cancelBtn.addEventListener("click", function () {
      modal.style.display = "none";
      targetForm = null;
    });

    confirmBtn.addEventListener("click", function () {
      if (targetForm) {
        targetForm.submit();
      }
    });

    window.addEventListener("click", function (e) {
      if (e.target === modal) {
        modal.style.display = "none";
        targetForm = null;
      }
    });
  });
</script>
{% endblock %}